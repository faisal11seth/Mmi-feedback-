<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MMI Ethics Feedback Tool</title>

  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --panel:#0b1220;
      --border:rgba(148,163,184,.22);
      --muted:#a3a3a3;
      --text:#ffffff;
      --accent:#6366f1;
      --accent2:#4f46e5;
      --danger:#fecaca;
      --success:#a7f3d0;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 40px 16px;
    }

    .wrap{
      width: min(980px, 96vw);
    }

    .card {
      background: var(--card);
      padding: 28px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.04);
    }

    h1 { margin: 0 0 10px 0; font-size: 26px; }
    h2 { margin: 0 0 10px 0; font-size: 18px; }
    h3 { margin: 18px 0 10px 0; font-size: 16px; }
    .muted { color: var(--muted); font-size: 13px; margin-bottom: 18px; }

    label { display:block; margin-top: 14px; font-size: 13px; color:#cbd5e1; }

    input, textarea, button {
      width: 100%;
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: white;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea { min-height: 110px; resize: vertical; }

    .station {
      margin-top: 16px;
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 14px;
      border-radius: 12px;
    }

    .timings {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 12px 0;
      color:#cbd5e1;
      font-size: 13px;
    }
    .pill {
      background: rgba(99,102,241,.12);
      border: 1px solid rgba(99,102,241,.35);
      padding: 6px 10px;
      border-radius: 999px;
    }

    .qbox{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      padding: 10px 12px;
      border-radius: 10px;
      margin-top: 8px;
      color:#e5e7eb;
      font-size: 14px;
      line-height: 1.35;
    }

    button {
      background: var(--accent);
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
      margin-top: 16px;
      padding: 12px 14px;
    }
    button:hover { background: var(--accent2); }
    button:disabled { opacity: .55; cursor: not-allowed; }

    .result {
      margin-top: 18px;
      background: #020617;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,.15);
    }

    .err { color: var(--danger); }
    .ok { color: var(--success); }

    .scores{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    .scoreCard{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 12px;
      font-weight: 700;
      display:flex;
      justify-content: space-between;
      align-items: center;
    }
    .scoreCard span{
      font-weight: 400;
      opacity: .95;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 16px 0;
    }

    .mono{
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 0;
      color: #e5e7eb;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12.8px;
      line-height: 1.45;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      padding: 12px;
      border-radius: 12px;
    }

    /* Station cards */
    .stationPicker{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 860px){
      .stationPicker{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 540px){
      .stationPicker{ grid-template-columns: 1fr; }
    }
    .sCard{
      text-align:left;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
      cursor:pointer;
      transition: transform .05s ease;
    }
    .sCard:hover{ transform: translateY(-1px); border-color: rgba(99,102,241,.45); }
    .sCard.active{
      border-color: rgba(99,102,241,.65);
      background: rgba(99,102,241,.12);
    }
    .sTitle{ font-weight: 800; margin-bottom: 6px; }
    .sMeta{ font-size: 12px; color:#cbd5e1; opacity: .95; line-height: 1.25; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>MMI Ethics Feedback</h1>
      <div class="muted">
        Pick a station. You’ll get domain scores + separate feedback for each question + rigid model answers (bullets + full).
      </div>

      <h2>Choose station</h2>
      <div id="stationPicker" class="stationPicker"></div>

      <label>Student name</label>
      <input id="studentName" placeholder="Type your name" />

      <div id="stationArea" class="station"></div>

      <button id="btn" onclick="submitAnswers()">Generate Feedback</button>

      <div id="output" class="result"></div>
    </div>
  </div>

<script>
  // Must match your backend station IDs in mark.js (STATIONS keys)
  const STATIONS = [
    {
      id: "blood_transfusion_refusal",
      title: "Refusal of life-saving blood transfusion",
      short: "Autonomy vs beneficence, MCA, refusal of treatment",
      timings: { reading: "2 minutes", response: "6 minutes", followups: "2 minutes" },
      description:
        "Ethics station assessing autonomy vs beneficence, capacity (Mental Capacity Act), informed refusal/consent, communication, escalation to seniors, documentation, and patient-centred care.",
      prompts: {
        main: "A patient refuses a life-saving blood transfusion for religious reasons. Discuss how you would approach this situation.",
        f1: "What would you do if the patient did not have capacity?",
        f2: "How would you involve the multidisciplinary team or family?",
        f3: "Can you suggest any ethically acceptable alternatives?"
      }
    },
    {
      id: "confidentiality_breach",
      title: "Confidentiality breach in corridor",
      short: "Professionalism, confidentiality, escalation",
      timings: { reading: "2 minutes", response: "6 minutes", followups: "2 minutes" },
      description:
        "Ethics/professionalism station assessing confidentiality, speaking up, managing colleagues, escalation pathways, and reflection.",
      prompts: {
        main: "You see a fellow student discussing identifiable patient information loudly in a corridor. What would you do?",
        f1: "What would you do if they became defensive or dismissed your concerns?",
        f2: "What if you think members of the public or other patients overheard?",
        f3: "Explain why confidentiality matters in clinical practice."
      }
    },
    {
      id: "colleague_error",
      title: "Medication dosing error",
      short: "Patient safety, speaking up, duty of candour",
      timings: { reading: "2 minutes", response: "6 minutes", followups: "2 minutes" },
      description:
        "Patient-safety station assessing recognising error, communication with colleague, escalation, duty of candour, and documenting/mitigating harm.",
      prompts: {
        main: "You notice a junior doctor has prescribed the wrong dose of a medication. What would you do?",
        f1: "What would you do if they dismiss your concern or refuse to change it?",
        f2: "What if the patient has already received the incorrect dose?",
        f3: "Why is it important to speak up about errors in healthcare?"
      }
    },
    {
      id: "dnar_conflict",
      title: "DNAR disagreement with family",
      short: "Communication, best interests, conflict resolution",
      timings: { reading: "2 minutes", response: "6 minutes", followups: "2 minutes" },
      description:
        "Ethics/communication station assessing DNAR principles, best interests, dealing with conflict and distress, and senior/MDT involvement.",
      prompts: {
        main: "A family insists you should attempt CPR despite a DNAR decision being in place. How would you approach this conversation and situation?",
        f1: "What would you do if the family become angry or accuse the team of ‘giving up’?",
        f2: "Who makes DNAR decisions, and what factors should be considered?",
        f3: "How would you support the family while maintaining appropriate clinical decisions?"
      }
    },
    {
      id: "capacity_refusal",
      title: "Refusal of surgery and capacity",
      short: "MCA capacity assessment, autonomy, documentation",
      timings: { reading: "2 minutes", response: "6 minutes", followups: "2 minutes" },
      description:
        "Ethics station assessing capacity (MCA), respecting refusal, exploring reasons, treating reversible causes, and best-interest decisions when capacity absent.",
      prompts: {
        main: "An elderly patient refuses a necessary operation that clinicians believe will significantly improve survival. How would you approach this?",
        f1: "How would you assess capacity under the Mental Capacity Act?",
        f2: "What would you do if capacity appears to fluctuate or is borderline?",
        f3: "When (if ever) could treatment proceed without consent?"
      }
    },
    {
      id: "breaking_bad_news",
      title: "Breaking bad news: new cancer diagnosis",
      short: "Communication, empathy, structure (SPIKES)",
      timings: { reading: "2 minutes", response: "6 minutes", followups: "2 minutes" },
      description:
        "Communication station assessing structure, empathy, clarity, checking understanding, supporting next steps, and signposting resources.",
      prompts: {
        main: "You need to explain a new cancer diagnosis to a patient. How would you do this?",
        f1: "What would you do if the patient becomes very distressed or starts crying?",
        f2: "What if the patient says they do not want to know any details?",
        f3: "Why is empathy and checking understanding essential in these conversations?"
      }
    },
    {
      id: "team_conflict",
      title: "Team conflict affecting care",
      short: "Professionalism, teamwork, escalation",
      timings: { reading: "2 minutes", response: "6 minutes", followups: "2 minutes" },
      description:
        "Professionalism station assessing teamworking, conflict resolution, patient safety, and escalation/leadership.",
      prompts: {
        main: "You notice tension and conflict within the clinical team and you think it is starting to affect patient care. What would you do?",
        f1: "What if your attempt to raise concerns is ignored?",
        f2: "Why is teamwork important for patient safety and outcomes?",
        f3: "What behaviours make teamwork effective in a busy clinical environment?"
      }
    },
    {
      id: "cultural_refusal",
      title: "Treatment refusal due to beliefs/culture",
      short: "Cultural sensitivity, shared decision-making",
      timings: { reading: "2 minutes", response: "6 minutes", followups: "2 minutes" },
      description:
        "Ethics station assessing culturally sensitive care, shared decision-making, respecting beliefs, and avoiding bias.",
      prompts: {
        main: "A patient refuses a recommended treatment due to cultural or religious beliefs. How would you approach this?",
        f1: "How would you show respect for the patient’s beliefs while still providing good care?",
        f2: "What would you do if the patient’s decision conflicts with your medical advice and you are worried about harm?",
        f3: "How do you avoid bias and ensure the patient feels heard and safe?"
      }
    },
    {
      id: "consent_understanding",
      title: "Consent: patient agrees but doesn’t understand",
      short: "Valid consent, teach-back, capacity",
      timings: { reading: "2 minutes", response: "6 minutes", followups: "2 minutes" },
      description:
        "Ethics station assessing valid informed consent, capacity, communication, teach-back, and documenting consent.",
      prompts: {
        main: "A patient says ‘yes’ to a procedure, but you suspect they do not understand what they are agreeing to. What would you do?",
        f1: "What are the key requirements for valid consent?",
        f2: "How would you check and improve understanding in a time-limited setting?",
        f3: "Why is informed consent ethically and legally important?"
      }
    },
    {
      id: "social_media_boundary",
      title: "Professional boundaries: social media request",
      short: "Boundaries, professionalism, confidentiality",
      timings: { reading: "2 minutes", response: "6 minutes", followups: "2 minutes" },
      description:
        "Professionalism station assessing boundaries, confidentiality risks, and appropriate online conduct.",
      prompts: {
        main: "A patient sends you a friend request on social media after a consultation. How would you respond?",
        f1: "Why are professional boundaries important in healthcare?",
        f2: "What are the potential risks of engaging with patients on social media?",
        f3: "What principles should guide a doctor’s social media use?"
      }
    }
  ];

  let selectedStationId = STATIONS[0].id;

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderStationPicker(){
    const el = document.getElementById("stationPicker");
    el.innerHTML = STATIONS.map(st => `
      <div class="sCard ${st.id === selectedStationId ? "active":""}" onclick="selectStation('${st.id}')">
        <div class="sTitle">${escapeHtml(st.title)}</div>
        <div class="sMeta">${escapeHtml(st.short)}</div>
      </div>
    `).join("");
  }

  function selectStation(id){
    selectedStationId = id;
    renderStationPicker();
    renderStationForm();
    // clear previous output when switching station
    document.getElementById("output").innerHTML = "";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function renderStationForm(){
    const st = STATIONS.find(x => x.id === selectedStationId);
    const area = document.getElementById("stationArea");

    area.innerHTML = `
      <h2>Station brief</h2>

      <div class="timings">
        <div class="pill">Reading: <b>${escapeHtml(st.timings.reading)}</b></div>
        <div class="pill">Response: <b>${escapeHtml(st.timings.response)}</b></div>
        <div class="pill">Follow-ups: <b>${escapeHtml(st.timings.followups)}</b></div>
      </div>

      <label>Station description (what the examiner is testing)</label>
      <div class="qbox">${escapeHtml(st.description)}</div>

      <label>Main ethics question</label>
      <div class="qbox">${escapeHtml(st.prompts.main)}</div>

      <label>Your answer (Main)</label>
      <textarea id="a_main" placeholder="Type your spoken answer to the main question..."></textarea>

      <h3>Follow-up 1</h3>
      <div class="qbox">${escapeHtml(st.prompts.f1)}</div>
      <label>Your answer (Follow-up 1)</label>
      <textarea id="a_f1" placeholder="Type your spoken answer to follow-up 1..."></textarea>

      <h3>Follow-up 2</h3>
      <div class="qbox">${escapeHtml(st.prompts.f2)}</div>
      <label>Your answer (Follow-up 2)</label>
      <textarea id="a_f2" placeholder="Type your spoken answer to follow-up 2..."></textarea>

      <h3>Follow-up 3</h3>
      <div class="qbox">${escapeHtml(st.prompts.f3)}</div>
      <label>Your answer (Follow-up 3)</label>
      <textarea id="a_f3" placeholder="Type your spoken answer to follow-up 3..."></textarea>
    `;
  }

  function renderResult(data){
    const s = data.scores || {};
    const fb = data.feedback || {};
    const models = (data.models || {}); // comes from backend: station.models

    const out = document.getElementById("output");
    out.innerHTML = `
      <h2>${escapeHtml(document.getElementById("studentName").value || "Candidate")}</h2>

      <div class="scores">
        <div class="scoreCard">Overall <span>${escapeHtml(s.overall)}/10</span></div>
        <div class="scoreCard">Empathy <span>${escapeHtml(s.empathy)}/10</span></div>
        <div class="scoreCard">Communication <span>${escapeHtml(s.communication)}/10</span></div>
        <div class="scoreCard">Ethics <span>${escapeHtml(s.ethics)}/10</span></div>
        <div class="scoreCard">Insight <span>${escapeHtml(s.insight)}/10</span></div>
      </div>

      <div class="divider"></div>

      <h2>Feedback — Main question</h2>
      <div class="qbox">${escapeHtml(fb.main || "")}</div>

      <h3>Model — Main (bullets)</h3>
      <pre class="mono">${escapeHtml(models.main?.bullets || "")}</pre>

      <h3>Model — Main (full)</h3>
      <pre class="mono">${escapeHtml(models.main?.full || "")}</pre>

      <div class="divider"></div>

      <h2>Feedback — Follow-up 1</h2>
      <div class="qbox">${escapeHtml(fb.f1 || "")}</div>

      <h3>Model — Follow-up 1 (bullets)</h3>
      <pre class="mono">${escapeHtml(models.f1?.bullets || "")}</pre>

      <h3>Model — Follow-up 1 (full)</h3>
      <pre class="mono">${escapeHtml(models.f1?.full || "")}</pre>

      <div class="divider"></div>

      <h2>Feedback — Follow-up 2</h2>
      <div class="qbox">${escapeHtml(fb.f2 || "")}</div>

      <h3>Model — Follow-up 2 (bullets)</h3>
      <pre class="mono">${escapeHtml(models.f2?.bullets || "")}</pre>

      <h3>Model — Follow-up 2 (full)</h3>
      <pre class="mono">${escapeHtml(models.f2?.full || "")}</pre>

      <div class="divider"></div>

      <h2>Feedback — Follow-up 3</h2>
      <div class="qbox">${escapeHtml(fb.f3 || "")}</div>

      <h3>Model — Follow-up 3 (bullets)</h3>
      <pre class="mono">${escapeHtml(models.f3?.bullets || "")}</pre>

      <h3>Model — Follow-up 3 (full)</h3>
      <pre class="mono">${escapeHtml(models.f3?.full || "")}</pre>
    `;
  }

  async function submitAnswers(){
    const btn = document.getElementById("btn");
    const out = document.getElementById("output");
    out.innerHTML = `<div class="muted">Marking…</div>`;

    btn.disabled = true;

    const payload = {
      stationId: selectedStationId,
      answers: {
        main: (document.getElementById("a_main")?.value || "").trim(),
        f1: (document.getElementById("a_f1")?.value || "").trim(),
        f2: (document.getElementById("a_f2")?.value || "").trim(),
        f3: (document.getElementById("a_f3")?.value || "").trim()
      }
    };

    try{
      const res = await fetch("/.netlify/functions/mark", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const text = await res.text();

      let data;
      try{
        data = JSON.parse(text);
      } catch(e){
        out.innerHTML = `<div class="err"><b>Error:</b> Function didn’t return JSON.</div><pre class="mono">${escapeHtml(text)}</pre>`;
        btn.disabled = false;
        return;
      }

      if (!res.ok || data.error){
        out.innerHTML = `<div class="err"><b>Error:</b> ${escapeHtml(data.error || "Request failed")}</div>
          <pre class="mono">${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
        btn.disabled = false;
        return;
      }

      renderResult(data);
      btn.disabled = false;

    } catch(err){
      out.innerHTML = `<div class="err"><b>Error:</b> ${escapeHtml(String(err))}</div>`;
      btn.disabled = false;
    }
  }

  // initial render
  renderStationPicker();
  renderStationForm();
</script>

</body>
</html>
