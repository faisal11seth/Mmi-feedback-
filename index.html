<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MMI Ethics Feedback</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      display: flex;
      justify-content: center;
      padding: 40px;
    }
    .card {
      background: #111827;
      padding: 28px;
      border-radius: 12px;
      width: min(860px, 96vw);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    h1 { margin: 0 0 6px 0; font-size: 22px; }
    .muted { color: #a3a3a3; font-size: 13px; margin-bottom: 18px; }

    label { display:block; margin-top: 14px; font-size: 13px; color:#cbd5e1; }
    input, textarea, button {
      width: 100%;
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,.25);
      background: #0b1220;
      color: white;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea { min-height: 90px; resize: vertical; }

    .station {
      margin-top: 16px;
      background: #0b1220;
      border: 1px solid rgba(148,163,184,.25);
      padding: 14px;
      border-radius: 10px;
    }
    .station h2 { margin: 0 0 10px 0; font-size: 16px; }
    .timings {
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px; color:#cbd5e1; font-size: 13px;
    }
    .pill {
      background: rgba(99,102,241,.12);
      border: 1px solid rgba(99,102,241,.35);
      padding: 6px 10px;
      border-radius: 999px;
    }

    .qblock{
      margin-top: 18px;
      padding: 14px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,.18);
      background: #0a1020;
    }
    .qblock h3{
      margin: 0 0 10px 0;
      font-size: 15px;
      color:#e5e7eb;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 800px){
      .row2{ grid-template-columns: 1fr; }
    }

    button {
      background: #6366f1;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
      margin-top: 18px;
      padding: 12px 14px;
    }
    button:hover { background: #4f46e5; }

    .result {
      margin-top: 18px;
      background: #020617;
      padding: 14px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,.15);
    }
    .err { color:#fecaca; }
    .sectionTitle { margin: 0 0 8px 0; font-size: 16px; }
    .scoregrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
      margin: 10px 0 12px 0;
      font-size: 13px;
    }
    .scorecell{
      background: rgba(148,163,184,.08);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 10px;
      padding: 8px 10px;
    }
    .scorecell b{ display:block; font-size: 12px; color:#cbd5e1; margin-bottom:4px; }
    .scorecell span{ font-size: 18px; font-weight: 800; }

    .textblock{
      background: rgba(148,163,184,.06);
      border: 1px solid rgba(148,163,184,.14);
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 10px;
      white-space: pre-wrap;
    }
    .readonly { opacity: .95; }
  </style>
</head>
<body>
  <div class="card">
    <h1>MMI Ethics Feedback</h1>
    <div class="muted">
      Fill in the prompts + your answers. You’ll get <b>separate domain scores (/10)</b>, feedback, and a <b>model answer</b> for each question.
    </div>

    <label>Student name</label>
    <input id="studentName" placeholder="Your name" />

    <div class="station">
      <h2>Station brief (pre-filled)</h2>
      <div class="timings">
        <div class="pill">Reading time: <b>2 minutes</b></div>
        <div class="pill">Response time: <b>6 minutes</b></div>
        <div class="pill">Follow-ups: <b>2 minutes</b></div>
      </div>

      <label>Station description (what this station is testing)</label>
      <textarea id="stationDescription" class="readonly" readonly>
This is a UK medical school MMI ethics station.

You are assessed on:
- Ethical reasoning using core principles (autonomy, beneficence, non-maleficence, justice)
- Capacity + consent + best interests (where relevant)
- Communication: structure, clarity, empathy, professionalism, signposting
- Managing conflict / safeguarding / escalation to seniors where appropriate
- Safety-netting and documentation
- GMC-style reasoning (balanced, patient-centred, proportionate)

Timing: 2 min read, 6 min main response, 2 min follow-up questions.
      </textarea>
    </div>

    <div class="qblock">
      <h3>1) Main ethics question</h3>
      <div class="row2">
        <div>
          <label>Main question prompt (paste the station scenario + main ask)</label>
          <textarea id="mainPrompt" placeholder="Paste the full scenario + main question here."></textarea>
        </div>
        <div>
          <label>Your answer (what you would say)</label>
          <textarea id="mainAnswer" placeholder="Write your spoken answer to the main question..."></textarea>
        </div>
      </div>
    </div>

    <div class="qblock">
      <h3>2) Follow-up question 2</h3>
      <div class="row2">
        <div>
          <label>Follow-up prompt</label>
          <textarea id="fu2Prompt" placeholder="Paste follow-up question 2 here (from your ethics form)."></textarea>
        </div>
        <div>
          <label>Your answer</label>
          <textarea id="fu2Answer" placeholder="Your answer to follow-up question 2..."></textarea>
        </div>
      </div>
    </div>

    <div class="qblock">
      <h3>3) Follow-up question 3</h3>
      <div class="row2">
        <div>
          <label>Follow-up prompt</label>
          <textarea id="fu3Prompt" placeholder="Paste follow-up question 3 here (from your ethics form)."></textarea>
        </div>
        <div>
          <label>Your answer</label>
          <textarea id="fu3Answer" placeholder="Your answer to follow-up question 3..."></textarea>
        </div>
      </div>
    </div>

    <button onclick="generateFeedback()">Generate Feedback</button>

    <div id="output" class="result"></div>
  </div>

<script>
function renderOne(title, block) {
  if (!block) return "";
  return `
    <div style="margin-top:14px;">
      <div class="sectionTitle">${title}</div>

      <div class="scoregrid">
        <div class="scorecell"><b>Empathy</b><span>${block.scores.empathy}</span></div>
        <div class="scorecell"><b>Communication</b><span>${block.scores.communication}</span></div>
        <div class="scorecell"><b>Ethics</b><span>${block.scores.ethics}</span></div>
        <div class="scorecell"><b>Insight</b><span>${block.scores.insight}</span></div>
        <div class="scorecell"><b>Overall</b><span>${block.scores.overall}</span></div>
      </div>

      <div class="textblock"><b>Feedback</b>\n${block.feedback}</div>
      <div class="textblock"><b>Model answer</b>\n${block.model_answer}</div>
    </div>
  `;
}

async function generateFeedback() {
  const payload = {
    student_name: document.getElementById("studentName").value || "",
    station_description: document.getElementById("stationDescription").value || "",
    timings: { reading_minutes: 2, response_minutes: 6, followups_minutes: 2 },

    main: {
      prompt: document.getElementById("mainPrompt").value || "",
      answer: document.getElementById("mainAnswer").value || ""
    },
    followup2: {
      prompt: document.getElementById("fu2Prompt").value || "",
      answer: document.getElementById("fu2Answer").value || ""
    },
    followup3: {
      prompt: document.getElementById("fu3Prompt").value || "",
      answer: document.getElementById("fu3Answer").value || ""
    }
  };

  const out = document.getElementById("output");
  out.innerHTML = "Marking…";

  const res = await fetch("/.netlify/functions/mark", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const text = await res.text();

  let data;
  try {
    data = JSON.parse(text);
  } catch {
    out.innerHTML = `<div class="err"><b>Error:</b> Function didn't return JSON.</div><div class="textblock">${text}</div>`;
    return;
  }

  if (!res.ok || data.error) {
    out.innerHTML = `<div class="err"><b>Error:</b> ${data.error || "Request failed"}</div><div class="textblock">${JSON.stringify(data, null, 2)}</div>`;
    return;
  }

  out.innerHTML = `
    <div><b>Candidate:</b> ${data.student_name || "Student"}</div>
    ${renderOne("Main question feedback", data.main)}
    ${renderOne("Follow-up question 2 feedback", data.followup2)}
    ${renderOne("Follow-up question 3 feedback", data.followup3)}
  `;
}
</script>
</body>
</html>
